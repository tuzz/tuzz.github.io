<!DOCTYPE html><html lang="en"><head><meta name="generator" content="React Static"/><title data-react-helmet="true">GameDev Notes 1: Taking the Plunge - tuzz.tech</title><meta charSet="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, shrink-to-fit=no"/><meta data-react-helmet="true" name="viewport" content="width=device-width, initial-scale=1.0"/><meta data-react-helmet="true" name="author" content="Chris Patuzzo"/><meta data-react-helmet="true" property="og:title" content="GameDev Notes 1: Taking the Plunge"/><meta data-react-helmet="true" property="og:url" content="https://tuzz.tech/blog/taking-the-plunge"/><meta data-react-helmet="true" property="og:type" content="article"/><meta data-react-helmet="true" property="og:description" content="How I added swimming to my indie platform game."/><meta data-react-helmet="true" name="description" content="How I added swimming to my indie platform game."/><meta data-react-helmet="true" name="keywords" content="Chris Patuzzo,game development,Rust,programming,swimming,water,underwater,animation"/><meta data-react-helmet="true" property="og:image" content="https://tuzz.tech/images/gamedev-1/cloak-fin.gif"/><meta data-react-helmet="true" property="og:image:secure_url" content="https://tuzz.tech/images/gamedev-1/cloak-fin.gif"/><meta data-react-helmet="true" property="og:image:width" content="300"/><meta data-react-helmet="true" property="og:image:height" content="300"/><meta data-react-helmet="true" property="og:video" content="https://tuzz.tech/videos/cloak-fin.mp4"/><meta data-react-helmet="true" property="og:video:secure_url" content="https://tuzz.tech/videos/cloak-fin.mp4"/><meta data-react-helmet="true" property="og:image:type" content="video/mp4"/><meta data-react-helmet="true" property="og:video:width" content="600"/><meta data-react-helmet="true" property="og:video:height" content="600"/><link rel="preload" as="script" href="/templates/__react_static_root__/app/pages/blog/adding-bash-completion.mdx~__react_static_root__/app/pages/blog~1caefab3.c0ff43d2.js"/><link rel="preload" as="script" href="/templates/__react_static_root__/app/pages/blog/taking-the-plunge.mdx.79674fe2.js"/><link rel="preload" as="script" href="/templates/styles.f5f0f4b2.js"/><link rel="preload" as="script" href="/templates/vendors~main.abecbdad.js"/><link rel="preload" as="script" href="/main.4c9105b0.js"/><link rel="preload" as="style" href="/main.6c84323b.css"/><link rel="stylesheet" href="/main.6c84323b.css"/><link rel="preload" as="style" href="/styles.c538bfc6.css"/><link rel="stylesheet" href="/styles.c538bfc6.css"/><link rel="preload" as="style" href="/__react_static_root__/app/pages/blog/adding-bash-completion.mdx~__react_static_root__/app/pages/blog~1caefab3.0295268c.css"/><link rel="stylesheet" href="/__react_static_root__/app/pages/blog/adding-bash-completion.mdx~__react_static_root__/app/pages/blog~1caefab3.0295268c.css"/><link rel="preload" as="style" href="/__react_static_root__/app/pages/blog/taking-the-plunge.mdx.abdf87e1.css"/><link rel="stylesheet" href="/__react_static_root__/app/pages/blog/taking-the-plunge.mdx.abdf87e1.css"/><link data-react-helmet="true" href="https://fonts.googleapis.com/css?family=Merriweather:400,400i|Source+Code+Pro:500,500i&amp;display=swap" rel="stylesheet"/><link data-react-helmet="true" rel="alternate" type="application/rss+xml" title="tuzz.tech" href="/feed.xml"/><link data-react-helmet="true" rel="icon" href="data:;base64,iVBORw0KGgo="/><link data-react-helmet="true" rel="prev" href="/blog/pair-programming-in-sentient"/></head><body><div id="root"><div style="outline:none" tabindex="-1"><div class="styles-layout_qpgG"><div class="styles-content_1JPb"><div style="outline:none" tabindex="-1"><div style="outline:none" tabindex="-1"><div class="styles-nav_bar_2D66"><span class="styles-breadcrumbs_2-AT"><a href="/blog/pair-programming-in-sentient">tuzz.tech</a><a href="/blog/pair-programming-in-sentient">blog</a></span><span class="styles-links_nqg2"><a href="/blog/pair-programming-in-sentient">← Previous</a><a>Next Article →</a></span></div><h1 class="styles-h1_3RZl">GameDev Notes 1:<br/>Taking the Plunge</h1><time dateTime="2020-10-02T12:00Z">Published <!-- -->October 2, 2020<!-- --> by <!-- --> <a href="https://twitter.com/chrispatuzzo" target="_blank">Chris Patuzzo</a><a href="/feed.xml" target="_blank" class="styles-feed_icon_SE8y"><svg width="16" height="16" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><circle cx="3.429" cy="20.571" r="3.429"></circle><path d="m11.429 24h4.57c0-8.821-7.178-15.999-15.999-16v4.572c6.302.001 11.429 5.126 11.429 11.428z"></path><path d="m24 24c0-13.234-10.766-24-24-24v4.571c10.714 0 19.43 8.714 19.43 19.429z"></path></svg></a></time><div class="note"><p>Follow me on <a href="https://twitter.com/chrispatuzzo" target="_blank">twitter</a> to hear how you can be
a playtester when the time comes.</p></div><p>For the past few months I’ve been writing my first ever indie game (in Rust).
It’s a 2D <span>puzzle-platformer</span> that I’m super
happy with so far. I think it’s pretty unique and I’m excited to see where it
goes. I’m quite stubborn and like things done a particular way so I’m not using
an off-the-shelf engine like Unity and I’m writing almost everything myself
except for some of the low-level libraries. It’s challenging and fun.</p><aside class="styles-aside_161L"><p>I haven’t named my game yet.</p></aside><p>Anyway, some friends suggested I share what I’ve been doing. Until now, I’ve
been reluctant to because I already have heaps to do but I think it would be a
shame if this knowledge is lost (because I’ll inevitably forget). Therefore,
I’m going to try and write occasional gamedev notes and publish them here. I
don’t guarantee they’ll all make sense without extra context. I’m hoping to
refer back to them later, e.g. if I turn them into YouTube videos or something.</p><p>Most recently (the last few days) I’ve been working on adding water and
swimming to the game. Currently the player character is land-based and I wanted
to expand that out to add variety and a new set of constraints for the player
to grapple with. There are story reasons as well, but I won’t spoil it. Before
diving(!) in, here’s a quick demo of what I made this week:</p><figure class="undefined styles-figure_23Vi"><a href="/videos/swimming-high-res.mp4" target="_blank"><video muted="" autoplay="" playsinline="" loop=""><source src="/videos/swimming-low-res.mp4" type="video/mp4"/></video></a><figcaption><span class="styles-arrow_2C7-">▲</span><span>Demo of swimming in my game (click for a higher resolution)</span></figcaption></figure><p>It probably doesn’t look much compared to AAA games but I added a few niceties
to make it visually interesting and fun to navigate. The first thing I worked
on was a new component called <code class="prism-code language-none"><span class="token-line"><span class="token plain">Liquid</span></span></code> that I can attach to a game entity. I
decided to use the more general term ‘liquid’ rather than ‘water’ because I
already use the term ‘solid’ and it seemed to fit better with the language of
my engine.</p><a href="#liquids"><h2 id="liquids" class="styles-h2_13mz">Liquids</h2></a><p>Here are the properties I can currently set on a liquid:</p><div><pre class="prism-code language-rust"><code class="prism-code language-rust"><span class="token-line"><span class="token plain">Liquid </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    direction_of_flow</span><span class="token punctuation">:</span><span class="token plain"> Vector2f</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    default_buoyancy</span><span class="token punctuation">:</span><span class="token plain"> Buoyancy </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">      upthrust</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token number">1.0</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">      drag_coefficients</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token number">0.15</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">3</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">      jump_scale_factor</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token number">0.4</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">      waterline</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token number">0.3</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">      settle_rate</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token number">0.01</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></span></code></pre></div><p>Before I can do anything interesting with these properties, I first need to
know which entities are ‘submerged’ in the liquid. I created a resource called
<code class="prism-code language-none"><span class="token-line"><span class="token plain">SubmergedEntities</span></span></code> that tracks this and a system that incrementally keeps this
resource up to date based on which entities have moved since the last update. I
consider an entity ‘submerged’ if its bounding box overlaps with the liquid,
even slightly. In other parts of the code I need to distinguish ‘partially’
versus ‘fully’ submerged, but I check this as needed.</p><p>With that out of the way, I wrote a <code class="prism-code language-none"><span class="token-line"><span class="token plain">LiquidPhysics</span></span></code> system that applies these
properties to submerged entities. I made it so this only applies to those that
have a <code class="prism-code language-none"><span class="token-line"><span class="token plain">Mass</span></span></code> component so that static geometry (e.g. the floor) isn’t
affected. I initially tried to make <code class="prism-code language-none"><span class="token-line"><span class="token plain">LiquidPhysics</span></span></code> work in harmony with my
existing <code class="prism-code language-none"><span class="token-line"><span class="token plain">GravityPhysics</span></span></code> system but that turned out to be really fiddly so I
abandoned that. Instead, it’s one or the other: if an entity is submerged,
<code class="prism-code language-none"><span class="token-line"><span class="token plain">LiquidPhysics</span></span></code> handles it. If it is not, <code class="prism-code language-none"><span class="token-line"><span class="token plain">GravityPhysics</span></span></code> does.</p><p>Here’s a quick summary of what each properties does:</p><ul><li><strong>direction_of_flow:</strong> controls the direction/speed entities move in the liquid</li><li><strong>upthrust:</strong> the same as above but only for the y-direction</li><li><strong>drag_coefficients:</strong> controls how rapidly an entity reaches the flow velocity when it’s not moving at that velocity, e.g. if the player jumps into some water, they will initially be travelling much faster than it</li><li><strong>jump_scale_factor:</strong> when an entity is ‘walking underwater’, i.e. it is standing on the ground in liquid, this parameter reduces the velocity applied when it jumps</li><li><strong>waterline:</strong> when an entity is floating at the top of the liquid, this parameter controls how high it naturally sits above the liquid, as a fraction of height</li><li><strong>settle rate:</strong> when an entity isn’t sitting at its waterline, this parameter controls how quickly it converges to it</li></ul><p>There’s quite a lot going on here but <code class="prism-code language-none"><span class="token-line"><span class="token plain">LiquidPhysics</span></span></code> didn’t turn out too
complicated, only 100 lines or so. I did a bunch of reading about <a href="https://en.wikipedia.org/wiki/Terminal_velocity" target="_blank">terminal
velocity</a> and
<a href="https://en.wikipedia.org/wiki/Drag_(physics)" target="_blank">drag</a> before writing it which
helped. The reason most of the properties are nested in a <code class="prism-code language-none"><span class="token-line"><span class="token plain">default_buoyancy</span></span></code>
field is so I can override them on a per-entity basis. For example, I might
want something to float on the surface while everything else sinks or to set a
lower waterline for a pirate ship.</p><a href="#swimming"><h2 id="swimming" class="styles-h2_13mz">Swimming</h2></a><p>I probably spent most of my time working on the swimming controls. I watched a
few videos of how swimming is typically handled in 2D games. In <a href="https://youtu.be/1wR8x5b_ExM?t=298" target="_blank">Super
Mario</a>, the swimming is a bit like jumping.
The player constantly sinks and swims up by jumping. They stay upright at all
times. I eventually got a nostalgia trip watching how swimming works in <a href="https://youtu.be/lSbLrWRLWl4?t=51" target="_blank">Ecco
the Dolphin</a>. I never really understood what
to do in that game but I remember it being fun to play. I like that the
character rotates to face the direction they’re heading. The boost is fun, too.</p><p>Currently, the on-land controls of my game are very responsive - you can
immediately switch directions. I figured it would be a nice change to introduce
some delay in water so you first have to turn to face the direction you want to
go, perhaps bumping into a wall along the way. You effectively always move in
the direction your head is pointing and turn at some arbitrary rate I can
control. Most people are better on land than in water so this fits well with
reality. Another minor reason for choosing this was that my engine works with
arbitrary transforms - it’s richer than a tile-based engine, which many 2D
games are built on, so I figured I may as well make use of this capability. If
I add analogue controller support, I can see it working well with that, too.</p><span></span><p>The way this works is by mapping the direction you’re pressing to one of the
eight intercardinal directions. I use the nautical term
‘<a href="https://en.wikipedia.org/wiki/Course_(navigation)" target="_blank">course</a>’ for this. I then
get the angle the player is current facing which I call its
‘<a href="https://en.wikipedia.org/wiki/Heading_(navigation)" target="_blank">heading</a>’ and figure out
which direction to turn to get there soonest. This is a bit fiddly because
angles wrap around and are usually in the range -PI to PI (from the
<a href="https://en.wikipedia.org/wiki/Atan2" target="_blank"><code class="prism-code language-none"><span class="token-line"><span class="token plain">atan2</span></span></code></a> function). Rust has a
<a href="https://doc.rust-lang.org/std/primitive.f32.html#method.rem_euclid" target="_blank"><code class="prism-code language-none"><span class="token-line"><span class="token plain">rem_euclid</span></span></code></a>
function that helps with this. In the case when the player switches to the
opposite direction (e.g. left to right), either direction works. I decided to
arbitrarily* turn counter-clockwise.</p><aside class="styles-aside_161L"><p>My very weak argument for turning counter-clockwise is that historically,
levels go from left to right so it seems likely you’d reach some goal at the
end of the level on the right. If you then want to return to ‘return home’,
you’d probably prefer to head up towards the surface, rather than down farther
into the water.</p></aside><p>Some things I added later were ‘hold space to boost’ (inspired by Ecco) and
automatic uprighting. If the player is idle, it seemed a bit weird to just
leave them hanging upside down in water so after a couple of seconds, I rotate
them back to their upright position. I quite liked the possibility of using
this for some tricky puzzle later in the game. Maybe there’s a spike-ridden
section that requires very fine turns and requires you to rotate back to your
upright position, rather than holding up and turning in a wider arc. That’s
pretty contrived, though.</p><p>One thing that caused me a headache was what to do at the surface of the water.
What was basically happening was the player was swimming past the waterline and
out of the liquid. They were then falling back down again when <code class="prism-code language-none"><span class="token-line"><span class="token plain">GravityPhysics</span></span></code>
kicked in, flipping between the two. It was very glitchy. My solution to this
was to introduce some logic for
‘<a href="https://ell.stackexchange.com/questions/95478/bobbing-in-the-water" target="_blank">bobbing</a>’
on the water. I tried a few variations but eventually settled on a simple
approach that allowed the player to keep swimming up for a small amount of time
above their waterline but at a greatly reduced speed. After which, they’d drop
down (at the same speed) until below the waterline where they could ‘bob up’
again.</p><p>To control the swim speed and rate they turn in water, I added <code class="prism-code language-none"><span class="token-line"><span class="token plain">swim_speed</span></span></code> and
<code class="prism-code language-none"><span class="token-line"><span class="token plain">turn_rate</span></span></code> to my pre-existing <code class="prism-code language-none"><span class="token-line"><span class="token plain">Agility</span></span></code> component that controls things like
the player’s foot speed and width of their jump arc.</p><a href="#walking-underwater"><h2 id="walking-underwater" class="styles-h2_13mz">Walking underwater</h2></a><p>I decided I wanted the player to be able to walk at the bottom of the liquid.
That’s kind of how it works in reality and it didn’t <em>seem</em> like it would be
hard to add. I basically distinguish between being ‘suspended’ in the liquid
and not (e.g. when walking at the bottom). When you’re not suspended, the
player controls fall through to the already existing walking/jumping controls
but with a few changes, mostly just slowing the player down and reducing their
jump velocity (using the <code class="prism-code language-none"><span class="token-line"><span class="token plain">jump_scale_factor</span></span></code> I mentioned earlier). You also
can’t boost to go faster.</p><p>The slight difficulty here is that normally, gravity is pushing down on you,
which keeps you on the ground. If you swim down to the ground but then stop
pressing down, it doesn’t know you’re still ‘touching’ the ground because
there’s nothing pushing you into it each update (unless the liquid has negative
flow in the y-direction). Maybe this isn’t a problem for better engines than
mine, but my fix was to basically constantly apply a negative velocity of the
player’s swim speed to keep them anchored on the ground after reaching it. I
like this solution because it means if the liquid has a lot of upthrust - more
than the player’s swim speed - they won’t be able to ‘cheat’ and stick to the
ground when they shouldn’t be able to. Similarly, my solution for bobbing on
the water has a similar property. Once you’re pushed under the water, its flow
takes over and out-paces your swim speed.</p><p>A problem I ran into at this point was with accidentally killing the player.
When walking on the ground, i first reset the player’s rotation so they’re
upright, but if they’re too close to the ground (swimming parallel to it), this
can sometimes place the player entity inside the ground. I have some code that
tries to detect if the player has been crushed based on the magnitude of
collision response. This can sometimes trip and kill the player. Not good!</p><p>My solution (read: hack) for this is to give the player a ‘free pass’ from the
grim reaper for a single frame - the exact moment their rotation is reset. I
also re-position the player slightly to reduce the size of this collision and
hopefully prevent any obscure/unlikely out-of-bounds problems this behaviour
could cause. From testing, this seems to work fine, although there are still
some weird things around locking on to ladders I need to look into when I have
some debugging energy.</p><p>Speaking of ladders, you can climb ladders underwater, too! Again, I made the
controls fall through to the existing code (the <code class="prism-code language-none"><span class="token-line"><span class="token plain">LadderControl</span></span></code> system) when it
detects you’re trying to climb. The only real difference is I don’t allow the
player to jump up from a ladder at all. They just ‘drop’ and go back to
swimming which seemed most natural.</p><p>Speaking of doors (oh, no one mentioned doors?), you can go through doors
underwater, too! Again, I made the controls &quot; &quot; &quot; &quot; &quot; &quot; ... you get the
idea. One thing to be slightly careful of is the ‘up’ key is now overloaded in
that the player uses it to <span>swim</span> up and to go
through doors. Underwater, it only activates the door if the ‘up’ key is
pressed and released again within half a second.</p><aside class="styles-aside_161L"><p>This was slightly
inspired by Vim’s leader key timeout. Whether it’ll feel ok in practice remains
to be seen.</p></aside><p>Fortunately, all of the above Just Works with another feature I have in the
engine: <strong>moving platforms</strong>. This glues entities to platforms if they’re
‘grounded’ on them. They inherit the velocity of the platform, which gives the
illusion they’re being moved by it. I’m glad this still works underwater
because I could see this being useful to move the player through water more
quickly than they can swim. One minor difference underwater is that I made the
player lose their momentum as soon as they leave the platform which seems more
realistic due to the increased drag of the water. On land, the player preserves
this momentum since the drag from air is negligible almost all the time (unless
you’re moving really quickly).</p><p>Finally, a slightly weird thing, as far as visuals are concerned is that the
player immediately flips to their upright position as soon as they touch the
ground. This looks strange if you’re swimming directly down and then are
flipped upright in the blink of an eye, but I won’t lose sleep over it.</p><a href="#animation"><h2 id="animation" class="styles-h2_13mz">Animation</h2></a><p>I’m <a href="https://twitter.com/chrispatuzzo/status/1276154571027550209" target="_blank">trying to
draw</a> the game
assets myself. It takes me forever but I basically use Procreate (like a
complete beginner) on my iPad Pro to draw individual sprites and then schedule
them using a <code class="prism-code language-none"><span class="token-line"><span class="token plain">SpriteAnimation</span></span></code> component in my engine. Here’s how I set up the
timings for the <code class="prism-code language-none"><span class="token-line"><span class="token plain">SWIM_RIGHT</span></span></code> animation:</p><div><pre class="prism-code language-rust"><code class="prism-code language-rust"><span class="token-line"><span class="token plain">Sequence</span><span class="token punctuation">::</span><span class="token function">looping</span><span class="token punctuation">(</span><span class="token function">vec!</span><span class="token punctuation">[</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    </span><span class="token punctuation">(</span><span class="token number">0.15</span><span class="token punctuation">,</span><span class="token plain"> SWIM_RIGHT_1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token number">0.25</span><span class="token punctuation">,</span><span class="token plain"> SWIM_RIGHT_2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token number">0.15</span><span class="token punctuation">,</span><span class="token plain"> SWIM_RIGHT_3</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    </span><span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">,</span><span class="token plain"> SWIM_RIGHT_4</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token number">0.15</span><span class="token punctuation">,</span><span class="token plain"> SWIM_RIGHT_5</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token number">0.4</span><span class="token punctuation">,</span><span class="token plain"> SWIM_RIGHT_6</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    </span><span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">,</span><span class="token plain"> SWIM_RIGHT_7</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">,</span><span class="token plain"> SWIM_RIGHT_8</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span><span class="token punctuation">]</span><span class="token punctuation">)</span></span></code></pre></div><p>The <code class="prism-code language-none"><span class="token-line"><span class="token plain">SWIM_RIGHT_6</span></span></code> frame is the one where the player character has his arms by
his side after performing a stroke of swimming. It’s supposed to look like
they’re gliding through the water for a brief moment before taking another
stroke. My drawing skills are not very good though. I really struggled to find
good side-on examples of people doing breast stroke (which I arbitrary decided
on). I found some <a href="https://www.youtube.com/watch?v=9K1hcdvTLAk" target="_blank">reference
videos</a> on YouTube that helped a
lot.</p><p>My treading water animation is even worse and I <em>might</em> replace it later, or
just get rid of it entirely but it’ll do for now. It kicks in when the player
is fully upright and not pressing a directional key in the water. It was
supposed to look like they were lifting their feet back a bit and leaning down
into the water, but it just looks like their legs are contorting awkwardly. Oh
well!</p><figure class="undefined styles-figure_23Vi"><a href="/images/gamedev-1/contorted-legs.png" target="_blank"><img src="/images/gamedev-1/contorted-legs.png" alt="Contorted legs"/></a><figcaption><span class="styles-arrow_2C7-">▲</span><span>Cortorted legs: I&#x27;m not very good at drawing!</span></figcaption></figure><p>After setting up an animation (like the one above), I have to schedule it to
play at the right time (and speed) based on what the player is doing. The logic
for this gets really hairy as you sometimes need to transition between
animations based on time delays, which animation was playing previously, which
direction the player was most recently facing, etc. My very painful way of
handling this is a giant <code class="prism-code language-none"><span class="token-line"><span class="token plain">match</span></span></code> statement that is a kind of state machine.</p><p>I originally wanted the player to fall into the water using their normal
falling animation before switching to the swimming animations after pressing a
directional key but I spent several frustrated hours trying to get this to work
properly. I eventually gave up and did a much simpler thing. Here are the lines
I added to my <code class="prism-code language-none"><span class="token-line"><span class="token plain">match</span></span></code> statement, which barely even use the conditions of the
match statement besides being <code class="prism-code language-none"><span class="token-line"><span class="token plain">suspended</span></span></code> (in liquid):</p><figure class="undefined styles-figure_23Vi"><div><pre class="prism-code language-rust"><code class="prism-code language-rust"><span class="token-line"><span class="token keyword">let</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">state</span><span class="token punctuation">,</span><span class="token plain"> speed</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">match</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">climbing</span><span class="token punctuation">,</span><span class="token plain"> grounded</span><span class="token punctuation">,</span><span class="token plain"> suspended</span><span class="token punctuation">,</span><span class="token plain"> x_dir</span><span class="token punctuation">,</span><span class="token plain"> y_dir</span><span class="token punctuation">,</span><span class="token plain"> previous</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain">previous_x</span><span class="token punctuation">,</span><span class="token plain"> time</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    </span><span class="token punctuation">(</span><span class="token plain">_</span><span class="token punctuation">,</span><span class="token plain"> _</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">true</span><span class="token punctuation">,</span><span class="token plain"> _</span><span class="token punctuation">,</span><span class="token plain"> _</span><span class="token punctuation">,</span><span class="token plain"> _</span><span class="token punctuation">,</span><span class="token plain"> _</span><span class="token punctuation">,</span><span class="token plain"> _</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token keyword">if</span><span class="token plain"> swimming </span><span class="token operator">==</span><span class="token plain"> UP    </span><span class="token operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">SWIM_UP</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    </span><span class="token punctuation">(</span><span class="token plain">_</span><span class="token punctuation">,</span><span class="token plain"> _</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">true</span><span class="token punctuation">,</span><span class="token plain"> _</span><span class="token punctuation">,</span><span class="token plain"> _</span><span class="token punctuation">,</span><span class="token plain"> _</span><span class="token punctuation">,</span><span class="token plain"> _</span><span class="token punctuation">,</span><span class="token plain"> _</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token keyword">if</span><span class="token plain"> swimming </span><span class="token operator">==</span><span class="token plain"> DOWN  </span><span class="token operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">SWIM_DOWN</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    </span><span class="token punctuation">(</span><span class="token plain">_</span><span class="token punctuation">,</span><span class="token plain"> _</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">true</span><span class="token punctuation">,</span><span class="token plain"> _</span><span class="token punctuation">,</span><span class="token plain"> _</span><span class="token punctuation">,</span><span class="token plain"> _</span><span class="token punctuation">,</span><span class="token plain"> _</span><span class="token punctuation">,</span><span class="token plain"> _</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token keyword">if</span><span class="token plain"> swimming </span><span class="token operator">==</span><span class="token plain"> LEFT  </span><span class="token operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">SWIM_LEFT</span><span class="token punctuation">,</span><span class="token plain"> swim_speed </span><span class="token operator">*</span><span class="token plain"> SWIM_SPEED</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    </span><span class="token punctuation">(</span><span class="token plain">_</span><span class="token punctuation">,</span><span class="token plain"> _</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">true</span><span class="token punctuation">,</span><span class="token plain"> _</span><span class="token punctuation">,</span><span class="token plain"> _</span><span class="token punctuation">,</span><span class="token plain"> _</span><span class="token punctuation">,</span><span class="token plain"> _</span><span class="token punctuation">,</span><span class="token plain"> _</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token keyword">if</span><span class="token plain"> swimming </span><span class="token operator">==</span><span class="token plain"> RIGHT </span><span class="token operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">SWIM_RIGHT</span><span class="token punctuation">,</span><span class="token plain"> swim_speed </span><span class="token operator">*</span><span class="token plain"> SWIM_SPEED</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span></span><span class="token-line"><span class="token plain">    </span><span class="token punctuation">(</span><span class="token plain">_</span><span class="token punctuation">,</span><span class="token plain"> _</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">true</span><span class="token punctuation">,</span><span class="token plain"> _</span><span class="token punctuation">,</span><span class="token plain"> _</span><span class="token punctuation">,</span><span class="token plain"> _</span><span class="token punctuation">,</span><span class="token plain"> _</span><span class="token punctuation">,</span><span class="token plain"> _</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token keyword">if</span><span class="token plain"> facing </span><span class="token operator">==</span><span class="token plain"> UP    </span><span class="token operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">TREAD_WATER</span><span class="token punctuation">,</span><span class="token plain"> TREAD_SPEED</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    </span><span class="token punctuation">(</span><span class="token plain">_</span><span class="token punctuation">,</span><span class="token plain"> _</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">true</span><span class="token punctuation">,</span><span class="token plain"> _</span><span class="token punctuation">,</span><span class="token plain"> _</span><span class="token punctuation">,</span><span class="token plain"> _</span><span class="token punctuation">,</span><span class="token plain"> _</span><span class="token punctuation">,</span><span class="token plain"> _</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token keyword">if</span><span class="token plain"> facing </span><span class="token operator">==</span><span class="token plain"> DOWN  </span><span class="token operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">SWIM_DOWN</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    </span><span class="token punctuation">(</span><span class="token plain">_</span><span class="token punctuation">,</span><span class="token plain"> _</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">true</span><span class="token punctuation">,</span><span class="token plain"> _</span><span class="token punctuation">,</span><span class="token plain"> _</span><span class="token punctuation">,</span><span class="token plain"> _</span><span class="token punctuation">,</span><span class="token plain"> _</span><span class="token punctuation">,</span><span class="token plain"> _</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token keyword">if</span><span class="token plain"> facing </span><span class="token operator">==</span><span class="token plain"> LEFT  </span><span class="token operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">UPRIGHT_LEFT</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    </span><span class="token punctuation">(</span><span class="token plain">_</span><span class="token punctuation">,</span><span class="token plain"> _</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">true</span><span class="token punctuation">,</span><span class="token plain"> _</span><span class="token punctuation">,</span><span class="token plain"> _</span><span class="token punctuation">,</span><span class="token plain"> _</span><span class="token punctuation">,</span><span class="token plain"> _</span><span class="token punctuation">,</span><span class="token plain"> _</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token keyword">if</span><span class="token plain"> facing </span><span class="token operator">==</span><span class="token plain"> RIGHT </span><span class="token operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">UPRIGHT_RIGHT</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span></span><span class="token-line"><span class="token plain">    </span><span class="token comment">// ... 50 much more horrible and order-dependent lines</span><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span></span></code></pre></div><figcaption><span class="styles-arrow_2C7-">▲</span><span><p>Scheduling the swimming animations to play at the right time</p></span></figcaption></figure><p>The <code class="prism-code language-none"><span class="token-line"><span class="token plain">SWIM_DOWN</span></span></code>, <code class="prism-code language-none"><span class="token-line"><span class="token plain">UPRIGHT_LEFT</span></span></code> and <code class="prism-code language-none"><span class="token-line"><span class="token plain">UPRIGHT_RIGHT</span></span></code> animations are just static
frames with the player facing in each of those directions. I tried and failed
for two or three hours to draw animations for swim up/down with the player
facing the camera. Eventually I gave and up decided to solve the problem the
way I know best, by layering on some programming to make the behaviour look
‘intentional’ rather than due to my hopelessness at drawing (see ‘Visual
delights’ below).</p><p>I decided to make the player face the camera when swimming up and have their
back to the player when swimming down. I partly did this for variety, but this
feels intuitively right to me for some reason and I don’t know why. Maybe
because when you’re swimming down, there’s less light so you can’t really see
where you’re going. I don’t know. What weird thing is going on in that head of
mine?</p><a href="#sprite-scaling"><h2 id="sprite-scaling" class="styles-h2_13mz">Sprite scaling</h2></a><p>Fun fact: the character in the swimming sprites is actually slightly smaller
than the rest of the sprites (e.g. when walking). This is because I needed to
scale it down to fit the extended arms and legs in. This really messed me up
and made the animation process more infuriating. I really didn’t want to change
the player’s transform size depending on which animation frame they were on, so
I implemented something I’ve wanted/needed in my engine for a while which is
‘sprite scaling’.</p><p>This basically allows you to scale the sprite of an entity to be larger (or
smaller) than its collider so that it can be displayed at one size, but it’s
treated in the engine at a different size - at least for the purpose of
collision detection / resolution, etc. I don’t know why I didn’t add this
sooner as it was really easy to add (10 minutes). It just never seemed high
enough priority, I guess.</p><p>The reason I’ve wanted this for a while is so I can stop the player hovering in
the air so much when they inch off a platform. There’s additional horizontal
space in the walking animation sprites that’s wider than the player’s feet. If
the collider is sized to the full width of the largest sprite, it means the
player can effectively stand on thin air when there’s the tiniest overlap at
the edge that meets the platform. With the updated size, you still can but to a
lesser extent than before:</p><figure class="undefined styles-figure_23Vi"><a href="/images/gamedev-1/thin-air.png" target="_blank"><img src="/images/gamedev-1/thin-air.png" alt="Standing on thin air"/></a><figcaption><span class="styles-arrow_2C7-">▲</span><span>Standing on thin air, the collision box is shown in red</span></figcaption></figure><p>After adding sprite scaling, I decided to take a bit of time out to size the
on-land sprites correctly first. I guess I just needed a break from the
swimming stuff for a few hours. This was a bit fiddly because many of the
triggers (e.g. when to move the camera) are activated when the player’s
collision box bumps into them. With that being slightly smaller, they ALL
needed to be moved by a smidgen. Mindless work but my frazzled brain didn’t
mind. I also made some of the puzzles easier by widening some platforms that
were a bit hard to land on with the reduced collider size. Here’s an example:</p><figure class="undefined styles-figure_23Vi"><a href="/images/gamedev-1/level-before.png" target="_blank"><img src="/images/gamedev-1/level-before.png" alt="Narrow platforms"/></a><figcaption><span class="styles-arrow_2C7-">▲</span><span>Narrow platforms: harder to land on with a smaller collision box</span></figcaption></figure><figure class="undefined styles-figure_23Vi"><a href="/images/gamedev-1/level-after.png" target="_blank"><img src="/images/gamedev-1/level-after.png" alt="Wider platforms"/></a><figcaption><span class="styles-arrow_2C7-">▲</span><span>Wider platforms: easier to land on with a smaller collision box</span></figcaption></figure><p>With sprite scaling in place, I could scale the swimming sprites up (a whopping
8%). You can see this slight scaling at the edges of the water where the
player’s head overlaps the wall a bit:</p><a href="#visual-delights"><h2 id="visual-delights" class="styles-h2_13mz">Visual delights</h2></a><p>With all the functional stuff out of the way, I decided to try and make things
pretty. The first thing I wanted to do something about were the static
animations I was using for swimming up and down. These are static frames where
the player is facing or has his back to the camera. Kind of naff. My
ingenious/ridiculous plan was to use the black smoke-y creature as a kind
of fin to make it look like it was propelling the player up or down. This is
the kind of thing I mean when I put &quot;creative problem solver&quot; on my CV.</p><figure class="undefined styles-figure_23Vi"><a href="/videos/cloak-fin.mp4" target="_blank"><video muted="" autoplay="" playsinline="" loop=""><source src="/videos/cloak-fin.mp4" type="video/mp4"/></video></a><figcaption><span class="styles-arrow_2C7-">▲</span><span>Creative problem solving: using the ‘cloak’ as a kind of fin</span></figcaption></figure><p>This was actually quite easy to implement. My particle system already supports
many of the features I need to emit particles relative to some rotated
direction (that oscillates back and forth). I made it so the ‘cloak’ is
attached to the player’s feet when swimming up or down and the rate of
oscillation and range of angles change when boosting (may as well add this). It
looks a bit goofy but it’s unique and I like it. It subtly reinforces the
notion this creature is there to help you, which may or may not be true. WHO
KNOWS!?</p><p>While I worked on that part of the code, I made a few changes that meant the
player wouldn’t have to wait around so much in other parts of the game.
Previously, the cloak’s behaviour was, for all intents and purposes, completely
random. Now it will do something potentially helpful with a configurable
probability. I can use this to tune the pace of the game for some of the
puzzles which might frustrate the player if they have to wait around too long.
Sorry I’m being so vague about all this, I don’t want to give <em>all</em> my secrets
away.</p><span></span><p>For the player, I added two emitters while swimming: <code class="prism-code language-none"><span class="token-line"><span class="token plain">AIR_BUBBLES</span></span></code> and
<code class="prism-code language-none"><span class="token-line"><span class="token plain">PROPULSION_BUBBLES</span></span></code>. The former is active all the time while the player is
submerged, whereas the latter activates while the player is submerged AND
pressing a directional key. My particle system is getting pretty fancy/mature
at this point which made adding emitters really easy. They’re basically just a
big bag of magic numbers. Here’s how <code class="prism-code language-none"><span class="token-line"><span class="token plain">AIR_BUBBLES</span></span></code> is set up:</p><figure class="undefined styles-figure_23Vi"><div><pre class="prism-code language-rust"><code class="prism-code language-rust"><span class="token-line"><span class="token plain">Emitter </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    enabled</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token keyword">true</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    spawn_rate</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token number">2.0</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain">                       </span><span class="token comment">// On average, emit two particles per second using a Poisson distribution.</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    texture</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">BUBBLE </span><span class="token keyword">as</span><span class="token plain"> f32</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    color_map</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token plain">STANDARD</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token keyword">as</span><span class="token plain"> </span><span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token plain">usize</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    opacity</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">..</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain">                   </span><span class="token comment">// Randomly choose an opacity between 0.5 and 1.0.</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    duration</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">..</span><span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    scale</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token number">0.05</span><span class="token punctuation">..</span><span class="token number">0.07</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain">                   </span><span class="token comment">// Randomly choose a uniform size.</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    rotation</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">..</span><span class="token number">2</span><span class="token punctuation">.</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> PI</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    position</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.1</span><span class="token punctuation">..</span><span class="token number">0.1</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">0.75</span><span class="token punctuation">..</span><span class="token number">0.95</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain">     </span><span class="token comment">// Position the bubbles approximately where the player&#x27;s face is.</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    velocity</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">..</span><span class="token number">1.0</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">0.5</span><span class="token punctuation">..</span><span class="token number">1.5</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain">       </span><span class="token comment">// Bubbles should generally travel upwards.</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    fade_time</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain">                       </span><span class="token comment">// Don&#x27;t fade out bubbles, make them pop.</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    z_index</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token number">1.0</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain">                          </span><span class="token comment">// Place bubbles in front the entity they&#x27;re attached to (the player).</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    lit</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token number">1.0</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain">                              </span><span class="token comment">// These particles are subject to lighting.</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    relative</span><span class="token punctuation">:</span><span class="token plain"> Relative </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">        velocity_rotation</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token keyword">false</span><span class="token punctuation">,</span><span class="token plain">                 </span><span class="token comment">// Bubbles should always travel upwards, regardless of player rotation.</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">        </span><span class="token punctuation">..</span><span class="token plain">Relative</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain">                     </span><span class="token comment">// (many other settings are hidden in here)</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></span></code></pre></div><figcaption><span class="styles-arrow_2C7-">▲</span><span><p>The particle emitter that produces air bubbles</p></span></figcaption></figure><aside class="styles-aside_161L"><p>I switch off the emitters as the player reaches the surface as I didn’t want
bubbles to travel above the liquid. This was fairly easy to introspect based on
the parameters of the emitter and the bounding boxes of the player and liquid.</p></aside><p>Finally, I added one more emitter: this time to the liquid. Currently, I just
render a pure blue sprite in front of the player with some a small opacity (0.3
or so). I wanted to try and convey the  (combined) <code class="prism-code language-none"><span class="token-line"><span class="token plain">direction_of_flow</span></span></code> and
<code class="prism-code language-none"><span class="token-line"><span class="token plain">upthrust</span></span></code> of the liquid to the player. I basically render some blurry black
and white particles that travel in the direction of flow (thin end first). It
took me some experimenting to settle on this approach. I first tried some
textured water sprites, but the particle approach looks pretty good I think and
is built from stuff I already have which I like.</p><p>If the liquid doesn’t have flow, I just randomly rotate the particles instead.
I reduce the opacity a bit to place less emphasis on the liquid’s
(non-existent) flow since I guess I want the player to not be subconsciously
confused by it. Here’s that emitter:</p><figure class="undefined styles-figure_23Vi"><div><pre class="prism-code language-rust"><code class="prism-code language-rust"><span class="token-line"><span class="token plain">Emitter </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    enabled</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token keyword">true</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    spawn_rate</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">scale</span><span class="token punctuation">.</span><span class="token plain">x </span><span class="token operator">*</span><span class="token plain"> scale</span><span class="token punctuation">.</span><span class="token plain">y </span><span class="token operator">*</span><span class="token plain"> </span><span class="token number">10</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain">             </span><span class="token comment">// The number of particles is proportional to the liquid&#x27;s area.</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    texture</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token plain">WHITE_BLUR</span><span class="token punctuation">,</span><span class="token plain"> BLACK_BLUR</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token keyword">as</span><span class="token plain"> </span><span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token plain">usize</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain">  </span><span class="token comment">// Add highlights and lowlights.</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    color_map</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token plain">STANDARD</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token keyword">as</span><span class="token plain"> </span><span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token plain">usize</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    opacity</span><span class="token punctuation">:</span><span class="token plain"> opacity</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    duration</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">..</span><span class="token number">5.0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    scale</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">..</span><span class="token number">1.0</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">0.1</span><span class="token punctuation">..</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain">                       </span><span class="token comment">// Randomly choose a non-uniform size (there are two ranges).</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    rotation</span><span class="token punctuation">:</span><span class="token plain"> angle</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    position</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token plain">scale</span><span class="token punctuation">.</span><span class="token plain">x</span><span class="token punctuation">..</span><span class="token plain">scale</span><span class="token punctuation">.</span><span class="token plain">x</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">scale</span><span class="token punctuation">.</span><span class="token plain">y</span><span class="token punctuation">..</span><span class="token plain">scale</span><span class="token punctuation">.</span><span class="token plain">y</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain">  </span><span class="token comment">// Particles emit uniformly from the entire region of the liquid.</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    velocity</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">x_vel</span><span class="token punctuation">,</span><span class="token plain"> y_vel</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain">                          </span><span class="token comment">// Match the flow of the water.</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    fade_time</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">..</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    z_index</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">3.0</span><span class="token punctuation">..</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain">                              </span><span class="token comment">// Place some particles in front and some behind submerged entities.</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    lit</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    relative</span><span class="token punctuation">:</span><span class="token plain"> Relative</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></code></pre></div><figcaption><span class="styles-arrow_2C7-">▲</span><span><p>Emitting particles in the direction of the liquid’s flow</p></span></figcaption></figure><figure class="undefined styles-figure_23Vi"><a href="/images/gamedev-1/liquid-flow.png" target="_blank"><img src="/images/gamedev-1/liquid-flow.png" alt="Swimming against flow"/></a><figcaption><span class="styles-arrow_2C7-">▲</span><span>A strong current with a particles extended in the direction of flow</span></figcaption></figure><a href="#summary"><h2 id="summary" class="styles-h2_13mz">Summary</h2></a><p>In summary, it turned out to be a surprising amount of work to add water and
swimming to my engine/game, but I’m fairly happy with the result. There’s
plenty that could be improved (e.g. hire an actual artist) but I probably
over-engineered things to a greater extent than I’ll ever need for most
scenarios. It took almost a full week of long days to figure all this out and
get it working the way I wanted.</p><p>Hopefully you got something out of this. I’ll announce more of these on
<a href="https://twitter.com/chrispatuzzo" target="_blank">twitter</a> so please follow me there.
Eventually I’ll open things up to playtesters so let me know there if that
appeals to you. Stay safe.</p><div class="styles-nav_bar_2D66"><span class="styles-breadcrumbs_2-AT"><a href="/blog/pair-programming-in-sentient">tuzz.tech</a><a href="/blog/pair-programming-in-sentient">blog</a></span><span class="styles-links_nqg2"><a href="/blog/pair-programming-in-sentient">← Previous</a><a>Next Article →</a></span></div></div></div></div></div><div class="styles-footer_1oSO"><p>© <!-- -->2020<!-- --> <!-- --> <a href="https://twitter.com/chrispatuzzo" target="_blank">Chris Patuzzo</a></p></div></div></div><script type="text/javascript">window.__routeInfo = JSON.parse("{\"template\":\"__react_static_root__/app/pages/blog/taking-the-plunge.mdx\",\"sharedHashesByProp\":{},\"data\":{},\"path\":\"blog/taking-the-plunge\",\"sharedData\":{},\"siteData\":{}}");</script><script defer="" type="text/javascript" src="/templates/__react_static_root__/app/pages/blog/adding-bash-completion.mdx~__react_static_root__/app/pages/blog~1caefab3.c0ff43d2.js"></script><script defer="" type="text/javascript" src="/templates/__react_static_root__/app/pages/blog/taking-the-plunge.mdx.79674fe2.js"></script><script defer="" type="text/javascript" src="/templates/styles.f5f0f4b2.js"></script><script defer="" type="text/javascript" src="/templates/vendors~main.abecbdad.js"></script><script defer="" type="text/javascript" src="/main.4c9105b0.js"></script></body></html>