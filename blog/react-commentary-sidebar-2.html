<!DOCTYPE html><html lang="en"><head><meta name="generator" content="React Static"/><title data-react-helmet="true">Building a commentary sidebar in React (cont.) - tuzz.tech</title><meta charSet="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, shrink-to-fit=no"/><meta data-react-helmet="true" name="viewport" content="width=device-width, initial-scale=1.0"/><meta data-react-helmet="true" name="author" content="Chris Patuzzo"/><meta data-react-helmet="true" property="og:title" content="Building a commentary sidebar in React (cont.)"/><meta data-react-helmet="true" property="og:url" content="https://tuzz.tech/blog/react-commentary-sidebar-2"/><meta data-react-helmet="true" property="og:type" content="article"/><meta data-react-helmet="true" property="og:description" content="Part two of building a commentary sidebar in React: taking a deeper look at the code."/><meta data-react-helmet="true" name="description" content="Part two of building a commentary sidebar in React: taking a deeper look at the code."/><meta data-react-helmet="true" name="keywords" content="Chris Patuzzo,React,commentary,sidebar,aside,hooks,printing,bug"/><meta data-react-helmet="true" property="og:image" content="https://tuzz.tech/images/commentary-sidebar.gif"/><meta data-react-helmet="true" property="og:image:secure_url" content="https://tuzz.tech/images/commentary-sidebar.gif"/><meta data-react-helmet="true" property="og:image:width" content="600"/><meta data-react-helmet="true" property="og:image:height" content="478"/><meta data-react-helmet="true" property="og:video" content="https://tuzz.tech/videos/commentary-sidebar.mp4"/><meta data-react-helmet="true" property="og:video:secure_url" content="https://tuzz.tech/videos/commentary-sidebar.mp4"/><meta data-react-helmet="true" property="og:image:type" content="video/mp4"/><meta data-react-helmet="true" property="og:video:width" content="1120"/><meta data-react-helmet="true" property="og:video:height" content="892"/><link rel="preload" as="script" href="/templates/__react_static_root__/app/pages/blog/adding-bash-completion.mdx~__react_static_root__/app/pages/blog~1caefab3.c0ff43d2.js"/><link rel="preload" as="script" href="/templates/__react_static_root__/app/pages/blog/react-commentary-sidebar-2.mdx.3efe647b.js"/><link rel="preload" as="script" href="/templates/styles.f5f0f4b2.js"/><link rel="preload" as="script" href="/templates/vendors~main.abecbdad.js"/><link rel="preload" as="script" href="/main.4c9105b0.js"/><link rel="preload" as="style" href="/main.6c84323b.css"/><link rel="stylesheet" href="/main.6c84323b.css"/><link rel="preload" as="style" href="/styles.c538bfc6.css"/><link rel="stylesheet" href="/styles.c538bfc6.css"/><link rel="preload" as="style" href="/__react_static_root__/app/pages/blog/adding-bash-completion.mdx~__react_static_root__/app/pages/blog~1caefab3.0295268c.css"/><link rel="stylesheet" href="/__react_static_root__/app/pages/blog/adding-bash-completion.mdx~__react_static_root__/app/pages/blog~1caefab3.0295268c.css"/><link rel="preload" as="style" href="/__react_static_root__/app/pages/blog/react-commentary-sidebar-2.mdx.61dc9c69.css"/><link rel="stylesheet" href="/__react_static_root__/app/pages/blog/react-commentary-sidebar-2.mdx.61dc9c69.css"/><link data-react-helmet="true" href="https://fonts.googleapis.com/css?family=Merriweather:400,400i|Source+Code+Pro:500,500i&amp;display=swap" rel="stylesheet"/><link data-react-helmet="true" rel="alternate" type="application/rss+xml" title="tuzz.tech" href="/feed.xml"/><link data-react-helmet="true" rel="icon" href="data:;base64,iVBORw0KGgo="/><link data-react-helmet="true" rel="prev" href="/blog/react-commentary-sidebar"/><link data-react-helmet="true" rel="next" href="/blog/grappling-with-infinity"/></head><body><div id="root"><div style="outline:none" tabindex="-1"><div class="styles-layout_qpgG"><div class="styles-content_1JPb"><div style="outline:none" tabindex="-1"><div style="outline:none" tabindex="-1"><div class="styles-nav_bar_2D66"><span class="styles-breadcrumbs_2-AT"><a href="/blog/pair-programming-in-sentient">tuzz.tech</a><a href="/blog/pair-programming-in-sentient">blog</a></span><span class="styles-links_nqg2"><a href="/blog/react-commentary-sidebar">← Previous</a><a href="/blog/grappling-with-infinity">Next Article →</a></span></div><h1 class="styles-h1_3RZl">Building a commentary sidebar in React (cont.)</h1><time dateTime="2019-10-30T12:01Z">Published <!-- -->October 30, 2019<!-- --> by <!-- --> <a href="https://twitter.com/chrispatuzzo" target="_blank">Chris Patuzzo</a><a href="/feed.xml" target="_blank" class="styles-feed_icon_SE8y"><svg width="16" height="16" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><circle cx="3.429" cy="20.571" r="3.429"></circle><path d="m11.429 24h4.57c0-8.821-7.178-15.999-15.999-16v4.572c6.302.001 11.429 5.126 11.429 11.428z"></path><path d="m24 24c0-13.234-10.766-24-24-24v4.571c10.714 0 19.43 8.714 19.43 19.429z"></path></svg></a></time><div class="note">This is the second of two parts. Part one is <a href="/blog/react-commentary-sidebar">here</a>.</div><p>In part one, we created a sidebar that lets us comment on articles. We built a
React component that auto-aligns itself with specific words or phrases. The
<code class="prism-code language-none"><span class="token-line"><span class="token plain">&lt;Aside&gt;</span></span></code> component binds a listener in case the window is resized:</p><span></span><figure class="undefined styles-figure_23Vi"><div><pre class="prism-code language-javascript"><code class="prism-code language-javascript"><span class="token-line"><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function maybe-class-name">Aside</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter punctuation">{</span><span class="token parameter"> target</span><span class="token parameter punctuation">,</span><span class="token parameter"> children</span><span class="token parameter punctuation">,</span><span class="token parameter"> moveDown </span><span class="token parameter punctuation">}</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">style</span><span class="token punctuation">,</span><span class="token plain"> setStyle</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span></span><span class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function">align</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> rectangle </span><span class="token operator">=</span><span class="token plain"> target</span><span class="token punctuation">.</span><span class="token property-access">current</span><span class="token punctuation">.</span><span class="token method function property-access">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> offset </span><span class="token operator">=</span><span class="token plain"> </span><span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token property-access">scrollY</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> rectangle</span><span class="token punctuation">.</span><span class="token property-access">top</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> moveDown</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span></span><span class="token-line"><span class="token plain">    </span><span class="token function">setStyle</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"> top</span><span class="token punctuation">:</span><span class="token plain"> offset </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span></span><span class="token-line"><span class="token plain">  </span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    </span><span class="token function">align</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// Align when the component is mounted.</span><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span></span><span class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> listener </span><span class="token operator">=</span><span class="token plain"> </span><span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;resize&quot;</span><span class="token punctuation">,</span><span class="token plain"> align</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">removeEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;resize&quot;</span><span class="token punctuation">,</span><span class="token plain"> listener</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span></span><span class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    </span><span class="token operator">&lt;</span><span class="token plain">aside className</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token plain">css</span><span class="token punctuation">.</span><span class="token property-access">aside</span><span class="token punctuation">}</span><span class="token plain"> style</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token plain">style</span><span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">      </span><span class="token punctuation">{</span><span class="token plain">children</span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    </span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token plain">aside</span><span class="token operator">&gt;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">  </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword module">default</span><span class="token plain"> </span><span class="token maybe-class-name">Aside</span><span class="token punctuation">;</span></span></code></pre></div><figcaption><span class="styles-arrow_2C7-">▲</span><span><p>Continuing from where we left off</p></span></figcaption></figure><aside class="styles-aside_161L"><p>This includes the <code class="prism-code language-none"><span class="token-line"><span class="token plain">moveDown</span></span></code> property which moves the comment down by an
additional fixed amount.</p></aside><p>In <span>this</span> part, we’ll extend the component
with additional functionality to make it more robust and better-able to cope
with slow-loading content, print layouts, etc.</p><aside class="styles-aside_161L"><p>We’ll also add some polish with a sweet CSS fade in animation.</p></aside><a href="#slow-loading-content"><h2 id="slow-loading-content" class="styles-h2_13mz">Slow-loading content</h2></a><p>Currently the component positions itself when mounted, but what happens if
images and fonts take a few seconds to load asynchronously? They might affect
the layout by pushing content down, throwing our comments out of alignment.
Something like this:</p><div class="styles-frame_2QDX"><iframe style="height:0px;transform:scale(1)" scrolling="no"></iframe><div class="styles-loading_2WpJ"></div></div><p>What we really want is for comments to re-align themselves after images and
other slow-loading content has loaded. How can we get this to work?</p><span></span><figure class="undefined styles-figure_23Vi"><div class="styles-frame_2QDX"><iframe style="height:0px;transform:scale(1)" scrolling="no"></iframe><div class="styles-loading_2WpJ"></div></div><figcaption><span class="styles-arrow_2C7-">▲</span><span><p>Re-aligning comments after images have loaded</p></span></figcaption></figure><aside class="styles-aside_161L"><p>Actually, if you refresh this page you’ll see these frames are examples of
slow-loading content.</p></aside><p>We could try and listen in to these events but that would mean polluting our app
with event listeners for all manner of things: we’d have to register <code class="prism-code language-none"><span class="token-line"><span class="token plain">onLoad</span></span></code>
events for images and try to use the
<a href="https://developer.mozilla.org/en-US/docs/Web/API/CSS_Font_Loading_API" target="_blank">Font Loading API</a> to
detect when fonts have loaded.</p><p>The simplest approach I’ve found is to just use timeouts re-align comments at
set times in anticipation of slow-loading content. This is a <em>hack</em> and isn’t
perfectly reliable, but I’ve found it works well enough in practice and it’s
easy to implement:</p><span></span><figure class="undefined styles-figure_23Vi"><div><pre class="prism-code language-javascript"><code class="prism-code language-javascript"><span class="token-line"><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function maybe-class-name">Aside</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter punctuation">{</span><span class="token parameter"> target</span><span class="token parameter punctuation">,</span><span class="token parameter"> children</span><span class="token parameter punctuation">,</span><span class="token parameter"> moveDown </span><span class="token parameter operator">=</span><span class="token parameter"> </span><span class="token parameter number">0</span><span class="token parameter"> </span><span class="token parameter punctuation">}</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">  </span><span class="token comment">// ...</span><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span></span><span class="token-line"><span class="token plain">  </span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> delays </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">500</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">1000</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">2500</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">5000</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">15000</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">30000</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> timeouts </span><span class="token operator">=</span><span class="token plain"> delays</span><span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">setTimeout</span><span class="token punctuation">(</span><span class="token plain">callback</span><span class="token punctuation">,</span><span class="token plain"> d</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span></span><span class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> timeouts</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token parameter">t</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">clearTimeout</span><span class="token punctuation">(</span><span class="token plain">t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span></span><span class="token-line"><span class="token plain">  </span><span class="token comment">// ...</span><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span></span></code></pre></div><figcaption><span class="styles-arrow_2C7-">▲</span><span><p>Using timeouts to re-align <code class="prism-code language-none"><span class="token-line"><span class="token plain">&lt;Aside&gt;</span></span></code> elements</p></span></figcaption></figure><aside class="styles-aside_161L">I re-align often early on as the page loads, then slow it down.</aside><p>There are cases where this approach won’t work. For example, if the user can
expand something on the page, the layout might change. We <span>could</span> additionally use <code class="prism-code language-none"><span class="token-line"><span class="token plain">setInterval</span></span></code> and periodically
re-align elements every few seconds as well.</p><aside class="styles-aside_161L"><p>I don’t really like using <code class="prism-code language-none"><span class="token-line"><span class="token plain">setInterval</span></span></code> if I can avoid it as it bloats the page.</p></aside><a href="#hooks"><h3 id="hooks" class="styles-h3_yb8_">Hooks</h3></a><p>To avoid cluttering our component, we can extract functionality into
<a href="https://reactjs.org/docs/hooks-intro.html" target="_blank">React hooks</a>:</p><span></span><figure class="undefined styles-figure_23Vi"><div><pre class="prism-code language-javascript"><code class="prism-code language-javascript"><span class="token-line"><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function">useDelays</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token parameter punctuation">,</span><span class="token parameter"> delays</span><span class="token parameter punctuation">,</span><span class="token parameter"> dependencies </span><span class="token parameter operator">=</span><span class="token parameter"> </span><span class="token parameter punctuation">[</span><span class="token parameter punctuation">]</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">  </span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> timeouts </span><span class="token operator">=</span><span class="token plain"> delays</span><span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">setTimeout</span><span class="token punctuation">(</span><span class="token plain">callback</span><span class="token punctuation">,</span><span class="token plain"> d</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span></span><span class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> timeouts</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token parameter">t</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">clearTimeout</span><span class="token punctuation">(</span><span class="token plain">t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> dependencies</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword module">default</span><span class="token plain"> useDelays</span><span class="token punctuation">;</span></span></code></pre></div><figcaption><span class="styles-arrow_2C7-">▲</span><span><p>Extracting a hook to register the timeouts</p></span></figcaption></figure><aside class="styles-aside_161L"><p>This hook optionally takes <code class="prism-code language-none"><span class="token-line"><span class="token plain">dependencies</span></span></code> to make it more reusable, but we
don’t strictly need it for our <code class="prism-code language-none"><span class="token-line"><span class="token plain">&lt;Aside&gt;</span></span></code> component.</p></aside><p>While we’re at it, let’s do the same for our resize listener:</p><span></span><figure class="undefined styles-figure_23Vi"><div><pre class="prism-code language-javascript"><code class="prism-code language-javascript"><span class="token-line"><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function">useResize</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token parameter punctuation">,</span><span class="token parameter"> dependencies </span><span class="token parameter operator">=</span><span class="token parameter"> </span><span class="token parameter punctuation">[</span><span class="token parameter punctuation">]</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">  </span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> listener </span><span class="token operator">=</span><span class="token plain"> </span><span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;resize&quot;</span><span class="token punctuation">,</span><span class="token plain"> callback</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span></span><span class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">removeEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;resize&quot;</span><span class="token punctuation">,</span><span class="token plain"> listener</span><span class="token punctuation">)</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> dependencies</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword module">default</span><span class="token plain"> useResize</span><span class="token punctuation">;</span></span></code></pre></div><figcaption><span class="styles-arrow_2C7-">▲</span><span><p>Extracting a hook to listen to the resize event</p></span></figcaption></figure><aside class="styles-aside_161L"><p>Again, this takes <code class="prism-code language-none"><span class="token-line"><span class="token plain">dependencies</span></span></code>.</p></aside><p>This neatens up our component considerably:</p><span></span><figure class="undefined styles-figure_23Vi"><div><pre class="prism-code language-javascript"><code class="prism-code language-javascript"><span class="token-line"><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function maybe-class-name">Aside</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter punctuation">{</span><span class="token parameter"> target</span><span class="token parameter punctuation">,</span><span class="token parameter"> children</span><span class="token parameter punctuation">,</span><span class="token parameter"> moveDown </span><span class="token parameter operator">=</span><span class="token parameter"> </span><span class="token parameter number">0</span><span class="token parameter"> </span><span class="token parameter punctuation">}</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">  </span><span class="token comment">// ...</span><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span></span><span class="token-line"><span class="token plain">  </span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token plain">align</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// Align when the component is mounted.</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">  </span><span class="token function">useResize</span><span class="token punctuation">(</span><span class="token plain">align</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">  </span><span class="token function">useDelays</span><span class="token punctuation">(</span><span class="token plain">align</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">500</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">1000</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">2500</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">5000</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">15000</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">30000</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span></span><span class="token-line"><span class="token plain">  </span><span class="token comment">// ...</span><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span></span></code></pre></div><figcaption><span class="styles-arrow_2C7-">▲</span><span><p>A much tidier component that uses hooks</p></span></figcaption></figure><aside class="styles-aside_161L"><p>My first pass at this component was a mess with ~100 lines of code. Hooks tidy things up a lot.</p></aside><p>We’ll use this approach of extracting hooks to keep our component clean as we
add sophistication. It also means these behaviours are modular and can be
reused later.</p><a href="#a-race-condition"><h2 id="a-race-condition" class="styles-h2_13mz">A race condition</h2></a><p>Occasionally, when resizing the window, React would throw the following error:</p><span></span><figure class="undefined styles-figure_23Vi"><a href="/images/get-bounding-rect-error.png" target="_blank"><img src="/images/get-bounding-rect-error.png" alt="getBoundingClientRect error"/></a><figcaption><span class="styles-arrow_2C7-">▲</span><span>An error that sometimes happens on resize</span></figcaption></figure><aside class="styles-aside_161L">As I write this article, I keep seeing this image and think I’ve broken the code. It’s very off-putting.</aside><p>I think this happens because of a race condition between the resize event and
React’s event loop. Sometimes <code class="prism-code language-none"><span class="token-line"><span class="token plain">target</span></span></code> refers to an <code class="prism-code language-none"><span class="token-line"><span class="token plain">undefined</span></span></code> element.</p><p>This <span>shouldn’t</span> be the case because the
referenced element always exists and is before the <code class="prism-code language-none"><span class="token-line"><span class="token plain">&lt;Aside&gt;</span></span></code> in the DOM, but
React might be in the middle of re-rendering the component and hasn’t updated
its <code class="prism-code language-none"><span class="token-line"><span class="token plain">ref</span></span></code> yet. It throws an error when we try to use it.</p><aside class="styles-aside_161L"><p>I’m not sure this is actually the problem but it’s my best guess. I’m by no means a React expert.</p></aside><p>We can fix this problem with a guard condition in the <code class="prism-code language-none"><span class="token-line"><span class="token plain">align</span></span></code> function:</p><span></span><figure class="undefined styles-figure_23Vi"><div><pre class="prism-code language-javascript"><code class="prism-code language-javascript"><span class="token-line"><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function">align</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> current </span><span class="token operator">=</span><span class="token plain"> target</span><span class="token punctuation">.</span><span class="token property-access">current</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">current</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// Guard a race condition.</span><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span></span><span class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> rectangle </span><span class="token operator">=</span><span class="token plain"> current</span><span class="token punctuation">.</span><span class="token method function property-access">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> offset </span><span class="token operator">=</span><span class="token plain"> </span><span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token property-access">scrollY</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> rectangle</span><span class="token punctuation">.</span><span class="token property-access">top</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> moveDown</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span></span><span class="token-line"><span class="token plain">  </span><span class="token function">setStyle</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"> top</span><span class="token punctuation">:</span><span class="token plain"> offset </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span></span></code></pre></div><figcaption><span class="styles-arrow_2C7-">▲</span><span><p>Fixing the problem by adding a guard clause</p></span></figcaption></figure><aside class="styles-aside_161L"><p>We could probably extract this into some kind of hook, too. I don’t want to go
too <em>hook-crazy</em>, though.</p></aside><a href="#debouncing"><h3 id="debouncing" class="styles-h3_yb8_">Debouncing</h3></a><p>The <span>above</span> error draws attention to the fact
that the browser fires hundreds of events when the window is resized. This
exasperates the problem because React competes with the resize handler for
execution time, making the race condition more likely.</p><aside class="styles-aside_161L"><p>An event is fired every time the dimensions of the window change, even by a small amount.</p></aside><p>We’ve fixed the problem by guarding against it, but it’s probably sensible to
also reduce the number of re-alignments per second. There’s no need to re-align
hundreds of times in a row as the user drags the edges of their browser to
resize it.</p><p>In the same spirit as before, we’ll use a hook for this:</p><span></span><figure class="undefined styles-figure_23Vi"><div><pre class="prism-code language-javascript"><code class="prism-code language-javascript"><span class="token-line"><span class="token keyword">const</span><span class="token plain"> alignSoon </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">useDebounce</span><span class="token punctuation">(</span><span class="token plain">align</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span><span class="token function">useResize</span><span class="token punctuation">(</span><span class="token plain">alignSoon</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span><span class="token function">useDelays</span><span class="token punctuation">(</span><span class="token plain">alignSoon</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">500</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">1000</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">2500</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">5000</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">15000</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">30000</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre></div><figcaption><span class="styles-arrow_2C7-">▲</span><span><p>Wrapping the <code class="prism-code language-none"><span class="token-line"><span class="token plain">align</span></span></code> function with a <code class="prism-code language-none"><span class="token-line"><span class="token plain">useDebounce</span></span></code> hook</p></span></figcaption></figure><aside class="styles-aside_161L"><p>We may as well debounce the timeouts as well in case the user is resizing at the same time.</p></aside><p>Now <span>when</span> the user resizes their browser,
there will be a delay of 50 milliseconds before comments are re-aligned, vastly
reducing the overhead of resizing.</p><aside class="styles-aside_161L"><p>It’s not JavaScript that’s expensive, it’s changes to the DOM and styles that
cause the page to re-render.</p><p>That’s partly why React is so popular because it defers updates until necessary
by using a <a href="https://reactjs.org/docs/faq-internals.html" target="_blank">virtual DOM</a>.</p></aside><p>This is noticeable, too. Before, when resizing the browser, the page was glitchy
and slow to update. It’s much smoother with debouncing. I didn’t write the
debouncing implementation, I used
<a href="https://gist.github.com/mudge/eb9178a4b6d595ffde8f9cb31744afcf" target="_blank">this one</a> from
<a href="https://twitter.com/tomstuart" target="_blank">Tom Stuart</a> and
<a href="https://twitter.com/mudge" target="_blank">Paul Mucur</a>.</p><a href="#printing"><h2 id="printing" class="styles-h2_13mz">Printing</h2></a><p>Honestly, <span>printing</span> web pages is a mess.
You’d expect to get more-or-less the same version of the page you can see when
you hit print, but that’s not how it works. Instead, it’s <a href="https://medium.com/freely-sharing-the-sum-of-all-knowledge/the-neglected-and-meandering-history-of-printing-websites-cf304824f9b1" target="_blank">steeped in
history</a>
and works in arbitrary and unexpected ways.</p><aside class="styles-aside_161L"><p>In Chrome and Firefox there is a way to print exactly what you see on screen but
<a href="https://superuser.com/questions/846082/how-to-get-wysiwyp-print-what-you-see-in-a-web-browser" target="_blank">it’s hidden</a> in dev tools.</p></aside><p>For example, some browsers fire <a href="https://caniuse.com/#feat=beforeafterprint" target="_blank"><code class="prism-code language-none"><span class="token-line"><span class="token plain">onbeforeprint</span></span></code> and
<code class="prism-code language-none"><span class="token-line"><span class="token plain">onafterprint</span></span></code></a> events. There’s also
<a href="https://developer.mozilla.org/en-US/docs/Web/API/MediaQueryList" target="_blank">MediaQueryList</a>
but <span>only</span>
<a href="https://developer.mozilla.org/en-US/docs/Web/API/MediaQueryList#Browser_compatibility" target="_blank">some browsers</a>
support event listeners. Other browsers scale content down by default and
remove backgrounds and images.</p><aside class="styles-aside_161L"><p>This is good because it saves ink, I just wish it was standardised.</p></aside><a href="#why-do-i-care"><h3 id="why-do-i-care" class="styles-h3_yb8_">Why do I care?</h3></a><p>I don’t actually think anyone will print these pages. The reason I care is
because printing has subsumed a feature people do actually use: exporting web
pages to PDF.</p><p>I’d <span>like</span> to be able to offer downloadable
versions of articles for offline reading or perhaps even produce a short ebook
someday. It’d be nice to use all the features I’ve developed for this blog
without having to familiarise myself with a new tool.</p><aside class="styles-aside_161L"><p><a href="https://github.com/fraserxu/electron-pdf" target="_blank">electron-pdf</a> looks to be a good
choice to automate the creation of PDFs from web pages. Alternatively,
<a href="https://pptr.dev/" target="_blank">Puppeteer</a> has support for this.</p></aside><a href="#the-problem"><h3 id="the-problem" class="styles-h3_yb8_">The problem</h3></a><p>When I first tried to print, I found the alignment of comments in the sidebar
was slightly off. Everything was a bit lower than it should be and this was
exaggerated further down with comments toward the end of the article. What’s
going on?</p><span></span><figure class="more_space border styles-figure_23Vi"><a href="/images/wrong-print-alignment.png" target="_blank"><img src="/images/wrong-print-alignment.png" alt="Wrong print alignment"/></a><figcaption><span class="styles-arrow_2C7-">▲</span><span>Incorrect alignment in Chrome’s print dialogue</span></figcaption></figure><aside class="styles-aside_161L"><p>The red arrows point to the targets of the <code class="prism-code language-none"><span class="token-line"><span class="token plain">&lt;Aside&gt;</span></span></code> elements. The comments are
all slightly misaligned.</p><p>At first I thought they were off by a fixed amount but it varies depending on
which page you’re on.</p></aside><p>I <span>think</span> what’s happening is a fresh version
of the page is rendered when the print dialogue is opened. It changes the
layout of the page by scaling its content and setting margins but doesn’t
trigger a resize event to re-align the comments.</p><aside class="styles-aside_161L"><p>I also found <a href="https://bugs.chromium.org/p/chromium/issues/detail?id=697233" target="_blank">this bug</a>
from 2017 which might be related. It doesn’t look like it’ll be fixed any time
soon.</p></aside><p>You can control some things through print stylesheets and <code class="prism-code language-none"><span class="token-line"><span class="token plain">@media print</span></span></code> style
rules but it’s harder to reliably detect in JavaScript when the page is being
printed.</p><a href="#the-solution"><h3 id="the-solution" class="styles-h3_yb8_">The solution</h3></a><p>Eventually, I wrote another hook that works <em>most</em> of the time:</p><span></span><span></span><span></span><figure class="undefined styles-figure_23Vi"><div><pre class="prism-code language-javascript"><code class="prism-code language-javascript"><span class="token-line"><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function">usePrint</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">onChange</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">isPrinting</span><span class="token punctuation">,</span><span class="token plain"> setPrinting</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span></span><span class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function">handleChange</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">printing</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">printing </span><span class="token operator">===</span><span class="token plain"> isPrinting</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span></span><span class="token-line"><span class="token plain">    </span><span class="token function">setPrinting</span><span class="token punctuation">(</span><span class="token plain">printing</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    </span><span class="token function">onChange</span><span class="token punctuation">(</span><span class="token plain">printing</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span></span><span class="token-line"><span class="token plain">  </span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> beforeListener </span><span class="token operator">=</span><span class="token plain"> </span><span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;beforeprint&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token function">handleChange</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> afterListener </span><span class="token operator">=</span><span class="token plain"> </span><span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;afterprint&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token function">handleChange</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span></span><span class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> printMedia </span><span class="token operator">=</span><span class="token plain"> </span><span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">matchMedia</span><span class="token punctuation">(</span><span class="token string">&quot;print&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> printListener </span><span class="token operator">=</span><span class="token plain"> printMedia</span><span class="token punctuation">.</span><span class="token method function property-access">addListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token function">handleChange</span><span class="token punctuation">(</span><span class="token plain">e</span><span class="token punctuation">.</span><span class="token property-access">matches</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span></span><span class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">      </span><span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">removeEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;beforeprint&quot;</span><span class="token punctuation">,</span><span class="token plain"> beforeListener</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">      </span><span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">removeEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;afterprint&quot;</span><span class="token punctuation">,</span><span class="token plain"> afterListener</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span></span><span class="token-line"><span class="token plain">      printMedia</span><span class="token punctuation">.</span><span class="token method function property-access">removeListener</span><span class="token punctuation">(</span><span class="token plain">printListener</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span></span><span class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> isPrinting</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword module">default</span><span class="token plain"> usePrint</span><span class="token punctuation">;</span></span></code></pre></div><figcaption><span class="styles-arrow_2C7-">▲</span><span><p>A React hook to detect print events</p></span></figcaption></figure><aside class="styles-aside_161L"><p><code class="prism-code language-none"><span class="token-line"><span class="token plain">handleChange</span></span></code> only calls <code class="prism-code language-none"><span class="token-line"><span class="token plain">onChange</span></span></code> if the state has actually changed. Some
browsers fire multiple print events at once.</p></aside><aside class="styles-aside_161L"><p>Notice the slight interface difference?</p><p><code class="prism-code language-none"><span class="token-line"><span class="token plain">addListener</span></span></code> vs. <code class="prism-code language-none"><span class="token-line"><span class="token plain">addEventListener</span></span></code></p><p>I didn’t.</p></aside><aside class="styles-aside_161L"><p>I made it so the hook returns <code class="prism-code language-none"><span class="token-line"><span class="token plain">isPrinting</span></span></code>, but I don’t actually use it in the
component.</p></aside><p>I then use this hook in the <code class="prism-code language-none"><span class="token-line"><span class="token plain">&lt;Aside&gt;</span></span></code> component to trigger a re-alignment. It’s
important not to debounce these calls. If we do, the print dialogue blocks the
page while it renders a print version and we’ve missed our slot.</p><p>Here’s how use the hook:</p><span></span><figure class="undefined styles-figure_23Vi"><div><pre class="prism-code language-javascript"><code class="prism-code language-javascript"><span class="token-line"><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function maybe-class-name">Aside</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter punctuation">{</span><span class="token parameter"> target</span><span class="token parameter punctuation">,</span><span class="token parameter"> children</span><span class="token parameter punctuation">,</span><span class="token parameter"> moveDown </span><span class="token parameter operator">=</span><span class="token parameter"> </span><span class="token parameter number">0</span><span class="token parameter"> </span><span class="token parameter punctuation">}</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">  </span><span class="token comment">// ...</span><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span></span><span class="token-line"><span class="token plain">  </span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token plain">align</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">  </span><span class="token function">usePrint</span><span class="token punctuation">(</span><span class="token plain">align</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain">  </span><span class="token comment">// Immediately call the function.</span><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span></span><span class="token-line"><span class="token plain">  </span><span class="token comment">// ...</span><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span></span></code></pre></div><figcaption><span class="styles-arrow_2C7-">▲</span><span><p>Re-aligning <code class="prism-code language-none"><span class="token-line"><span class="token plain">&lt;Aside&gt;</span></span></code> elements on print</p></span></figcaption></figure><aside class="styles-aside_161L">It took me a while to figure out not to debounce these calls.</aside><p>This hook isn’t perfect but it seems to work well in Chrome and Safari. I still
need to do more work to add a print stylesheet to make it look nice but at
least it’s no longer broken... except in Firefox which likes to overlap all the
comments:</p><span></span><figure class="undefined styles-figure_23Vi"><a href="/images/firefox-broken-comments.png" target="_blank"><img src="/images/firefox-broken-comments.png" alt="Broken comments while printing in Firefox"/></a><figcaption><span class="styles-arrow_2C7-">▲</span><span>Printing comments in Firefox is still broken</span></figcaption></figure><aside class="styles-aside_161L"><p>This is how Firefox prints the comments for <em>this</em> article.</p></aside><p>I’ll try to fix it someday but for now I’m happy it works in WebKit. That means
I can produce prepared PDFs, rather than encourage <em>anyone</em> to use the print
dialogue.</p><a href="#final-touches"><h2 id="final-touches" class="styles-h2_13mz">Final touches</h2></a><p>It can look messy if <code class="prism-code language-none"><span class="token-line"><span class="token plain">&lt;Aside&gt;</span></span></code> elements jump around a lot as the page loads.
This will happen a bit as slow-loading content is added to the page but we can
smooth things over a little by fading in our comments after the first alignment
has happened:</p><div><pre class="prism-code language-javascript"><code class="prism-code language-javascript"><span class="token-line"><span class="token keyword">const</span><span class="token plain"> </span><span class="token function">align</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">  </span><span class="token comment">//...</span><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span></span><span class="token-line"><span class="token plain">  </span><span class="token function">setStyle</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"> top</span><span class="token punctuation">:</span><span class="token plain"> offset</span><span class="token punctuation">,</span><span class="token plain"> opacity</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">,</span><span class="token plain"> transition</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&quot;opacity 0.3s&quot;</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></span></code></pre></div><p>Also, if you’re using <code class="prism-code language-none"><span class="token-line"><span class="token plain">&lt;Aside&gt;</span></span></code> elements a lot, be mindful that each time you
do, even listeners are being registered on <code class="prism-code language-none"><span class="token-line"><span class="token plain">window</span></span></code>. This can add up over time:</p><span></span><figure class="border styles-figure_23Vi"><a href="/images/many-resize-listeners.png" target="_blank"><img src="/images/many-resize-listeners.png" alt="Many resize listeners"/></a><figcaption><span class="styles-arrow_2C7-">▲</span><span>Event listeners registered for the window</span></figcaption></figure><aside class="styles-aside_161L"><p>You can see registered listeners in Chrome by inspecting any element, opening the ‘Event Listeners’ tab then selecting the ‘Ancestors’ option.</p></aside><p>It <span>would</span> be better to register a single
handler for each type of event and re-align all comments through that. I
haven’t implemented this but will probably add this later.</p><aside class="styles-aside_161L"><p><a href="https://hackernoon.com/do-you-still-register-window-event-listeners-in-each-component-react-in-example-31a4b1f6f1c8" target="_blank">This</a>
looks to be a good resource on how to do this using <a href="https://en.wikipedia.org/wiki/Publish%E2%80%93subscribe_pattern" target="_blank">PubSub</a>.</p><p>Alternatively, you could use <a href="https://redux.js.org/" target="_blank">Redux</a>.</p></aside><a href="#final-thoughts"><h3 id="final-thoughts" class="styles-h3_yb8_">Final thoughts</h3></a><p>In this article, we’ve taken a detailed look at how to build a commentary
sidebar in React. This has a few rough edges but overall I’m really happy with
how it turned out.</p><p>It’s already become an integral part of how I think about writing. A tool I can
reach for when I want to say <em>a little bit more</em> about something, without being
too distracting.</p><p>I’m really enjoying the process of writing and learning React so it’s been fun
to combine the two. For reference, here’s the most up to date version of the
code:</p><span></span><span></span><span></span><figure class="undefined styles-figure_23Vi"><div><pre class="prism-code language-jsx"><code class="prism-code language-jsx"><span class="token-line"><span class="token keyword module">import</span><span class="token plain"> css </span><span class="token keyword module">from</span><span class="token plain"> </span><span class="token string">&quot;./styles.scss&quot;</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function maybe-class-name">Aside</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter punctuation">{</span><span class="token parameter"> target</span><span class="token parameter punctuation">,</span><span class="token parameter"> children</span><span class="token parameter punctuation">,</span><span class="token parameter"> moveDown </span><span class="token parameter operator">=</span><span class="token parameter"> </span><span class="token parameter number">0</span><span class="token parameter"> </span><span class="token parameter punctuation">}</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">style</span><span class="token punctuation">,</span><span class="token plain"> setStyle</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span></span><span class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function">align</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> current </span><span class="token operator">=</span><span class="token plain"> target</span><span class="token punctuation">.</span><span class="token property-access">current</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">current</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// Guard a race condition.</span><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span></span><span class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> rectangle </span><span class="token operator">=</span><span class="token plain"> current</span><span class="token punctuation">.</span><span class="token method function property-access">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> offset </span><span class="token operator">=</span><span class="token plain"> </span><span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token property-access">scrollY</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> rectangle</span><span class="token punctuation">.</span><span class="token property-access">top</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> moveDown</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span></span><span class="token-line"><span class="token plain">    </span><span class="token function">setStyle</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"> top</span><span class="token punctuation">:</span><span class="token plain"> offset</span><span class="token punctuation">,</span><span class="token plain"> opacity</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">,</span><span class="token plain"> transition</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&quot;opacity 0.3s&quot;</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span></span><span class="token-line"><span class="token plain">  </span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token plain">align</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">  </span><span class="token function">usePrint</span><span class="token punctuation">(</span><span class="token plain">align</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span></span><span class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> alignSoon </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">useDebounce</span><span class="token punctuation">(</span><span class="token plain">align</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span></span><span class="token-line"><span class="token plain">  </span><span class="token function">useResize</span><span class="token punctuation">(</span><span class="token plain">alignSoon</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">  </span><span class="token function">useDelays</span><span class="token punctuation">(</span><span class="token plain">alignSoon</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">500</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">1000</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">2500</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">5000</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">15000</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">30000</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span></span><span class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    </span><span class="token tag punctuation">&lt;</span><span class="token tag">aside</span><span class="token tag"> </span><span class="token tag attr-name">className</span><span class="token tag script language-javascript script-punctuation punctuation">=</span><span class="token tag script language-javascript punctuation">{</span><span class="token tag script language-javascript">css</span><span class="token tag script language-javascript punctuation">.</span><span class="token tag script language-javascript property-access">aside</span><span class="token tag script language-javascript punctuation">}</span><span class="token tag"> </span><span class="token tag attr-name">style</span><span class="token tag script language-javascript script-punctuation punctuation">=</span><span class="token tag script language-javascript punctuation">{</span><span class="token tag script language-javascript">style</span><span class="token tag script language-javascript punctuation">}</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">      </span><span class="token punctuation">{</span><span class="token plain">children</span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">    </span><span class="token tag punctuation">&lt;/</span><span class="token tag">aside</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain">  </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span></span><span class="token-line"><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword module">default</span><span class="token plain"> </span><span class="token maybe-class-name">Aside</span><span class="token punctuation">;</span></span></code></pre></div><figcaption><span class="styles-arrow_2C7-">▲</span><span><p>  The ‘live’ version of the code powering this blog</p></span></figcaption></figure><aside class="styles-aside_161L"><p>I might improve this code over time but this article should automatically update to reflect that.</p></aside><aside class="styles-aside_161L"><p>If you want to see the version of the code, frozen in time when this article was
written, it’s <a href="https://github.com/tuzz/tuzz.tech/blob/caa688d1847ae2db7c0c0376588a2431f281f220/components/aside/index.jsx" target="_blank">here</a>.</p></aside><aside class="styles-aside_161L"><p>Maybe I should explain how the live code embedding works, too? I’ll save that for another day.</p></aside><div class="styles-nav_bar_2D66"><span class="styles-breadcrumbs_2-AT"><a href="/blog/pair-programming-in-sentient">tuzz.tech</a><a href="/blog/pair-programming-in-sentient">blog</a></span><span class="styles-links_nqg2"><a href="/blog/react-commentary-sidebar">← Previous</a><a href="/blog/grappling-with-infinity">Next Article →</a></span></div></div></div></div></div><div class="styles-footer_1oSO"><p>© <!-- -->2020<!-- --> <!-- --> <a href="https://twitter.com/chrispatuzzo" target="_blank">Chris Patuzzo</a></p></div></div></div><script type="text/javascript">window.__routeInfo = JSON.parse("{\"template\":\"__react_static_root__/app/pages/blog/react-commentary-sidebar-2.mdx\",\"sharedHashesByProp\":{},\"data\":{},\"path\":\"blog/react-commentary-sidebar-2\",\"sharedData\":{},\"siteData\":{}}");</script><script defer="" type="text/javascript" src="/templates/__react_static_root__/app/pages/blog/adding-bash-completion.mdx~__react_static_root__/app/pages/blog~1caefab3.c0ff43d2.js"></script><script defer="" type="text/javascript" src="/templates/__react_static_root__/app/pages/blog/react-commentary-sidebar-2.mdx.3efe647b.js"></script><script defer="" type="text/javascript" src="/templates/styles.f5f0f4b2.js"></script><script defer="" type="text/javascript" src="/templates/vendors~main.abecbdad.js"></script><script defer="" type="text/javascript" src="/main.4c9105b0.js"></script></body></html>