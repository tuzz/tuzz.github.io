#!/usr/bin/env ruby

require "fileutils"

def export_name(path)
  File.basename(path, ".mdx").split("-").map.with_index do |part, index|
    index == 0 ? part : part.capitalize
  end.join
end

generated_code = Dir.glob("app/pages/**/*.mdx").map do |path|
  lines = File.read(path).split("\n")

  exports = lines.select { |l| l.include?("export const") }
  fields = exports.map { |e| e.sub("export const ", "").sub(" =", ":").sub(/;$/, ",\n") }

  code = "export const #{export_name(path)} = {\n  #{fields.join("  ")}};\n"

  date_export = exports.detect { |e| e.include?("export const date") }
  publish_date = date_export[/".*"/]

  [publish_date, code]
end.sort_by(&:first).map(&:last).join("\n")

File.open("app/helpers/page_listing.js", "w") do |file|
  file.puts "// This file is generated by #{__FILE__}"
  file.puts
  file.puts generated_code
end
